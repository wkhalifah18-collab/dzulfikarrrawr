<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: "Segoe UI", sans-serif; background: #f5f6fa; margin: 0; padding: 20px; }
.container { max-width: 600px; margin: auto; }
.checkout-item { display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px; margin-bottom: 10px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.checkout-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
form { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 20px; }
label { display: block; margin-top: 10px; font-weight: 600; }
input, textarea, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px; }
#manual-payment { display: none; background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 15px; }
#bukti-container { display: none; margin-top: 15px; text-align: center; }
#preview-bukti { margin-top: 10px; width: 100%; max-width: 300px; border-radius: 8px; border: 1px solid #ccc; display: none; }
button { width: 100%; padding: 12px; background: #2ecc71; border: none; color: white; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 20px; }
button:hover { background: #27ae60; }
.total { font-weight: bold; font-size: 18px; text-align: right; margin-top: 10px; }
</style>
</head>

<body>
<div class="container">
  <h2>Checkout</h2>

  <div id="checkout-list"></div>
  <div class="total">Total: <span id="total-price">Rp0</span></div>

  <form id="checkout-form">
    <label>Nama Lengkap</label>
    <input type="text" id="nama" required>

    <label>Nomor HP</label>
    <input type="tel" id="telepon" required pattern="[0-9]{10,15}">

    <label>Alamat Lengkap</label>
    <textarea id="alamat" required></textarea>

    <label>Pilih Metode Pembayaran:</label>
    <select id="payment-method" required>
      <option value="">-- Pilih Metode --</option>
      <option value="Shopeepay">Shopeepay</option>
      <option value="Gopay">GoPay</option>
      <option value="Ovo">Ovo</option>
      <option value="Seabank">Seabank</option>
      <option value="Neobank">Neobank</option>
    </select>

    <div id="manual-payment"></div>

    <div id="bukti-container">
      <label>Upload Bukti Transfer:</label>
    <input type="file" id="bukti" accept="image/*" required>

      <img id="preview-bukti">
    </div>

    <button type="submit">Selesai Bayar</button>
  </form>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const SUPABASE_URL = "https://hbfthwohrrzqitxbfeqc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhiZnRod29ocnJ6cWl0eGJmZXFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NzQ1MzQsImV4cCI6MjA4MDA1MDUzNH0.TxKRzjhqU85Iz9z6ZQgRg7uorDNALoVLq0GIf9MRNxM";
  const BUCKET_NAME = "bukti-pembayaran";

  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const checkoutList = document.getElementById("checkout-list");
  const totalPriceEl = document.getElementById("total-price");
  const paymentSelect = document.getElementById("payment-method");
  const manualPayment = document.getElementById("manual-payment");
  const buktiContainer = document.getElementById("bukti-container");

  const namaInput = document.getElementById("nama");
  const teleponInput = document.getElementById("telepon");
  const alamatInput = document.getElementById("alamat");
  const checkoutForm = document.getElementById("checkout-form");
  const buktiInput = document.getElementById("bukti");

  const formatRupiah = n => "Rp" + Number(n).toLocaleString("id-ID");

  const cart = JSON.parse(localStorage.getItem("checkout"));

  if (!cart || cart.length === 0) {
    checkoutList.innerHTML = `<p style="text-align:center;color:#999;">Keranjang kamu kosong</p>`;
    return;
  }

  let total = 0;

  checkoutList.innerHTML = cart.map(item => {
    const image = item.image || item.img || item.foto || "https://via.placeholder.com/60";
    const name = item.name || item.nama_produk || "Produk";
    const size = item.size || item.ukuran || "-";
    const price = Number(item.price || item.harga || 0);
    const qty = Number(item.qty || 1);

    total += price * qty;

    return `
      <div class="checkout-item">
        <div style="display:flex;align-items:center;gap:10px;">
          <img src="${image}">
          <div>
            <strong>${name}</strong><br>
            <small>Ukuran: ${size}</small><br>
            <span style="color:green;">${formatRupiah(price * qty)}</span>
          </div>
        </div>
        <span>x${qty}</span>
      </div>
    `;
  }).join("");

  totalPriceEl.textContent = formatRupiah(total);

  const paymentInfo = {
    Shopeepay: "Nomor: 082197770219 (DZULFIKAR RAYHAN BOWENG)",
    Gopay: "Nomor: 082197770219 (DZULFIKAR RAYHAN BOWENG)",
    Ovo: "Nomor: 082197770219 (DZULFIKAR RAYHAN BOWENG)",
    Seabank: "Rek: 9019-0569-4689",
    Neobank: "Rek: 5859-4572-0870-8191"
  };

  paymentSelect.addEventListener("change", () => {
    const value = paymentSelect.value;

    if (!value) {
      manualPayment.style.display = "none";
      buktiContainer.style.display = "none";
      return;
    }

    manualPayment.style.display = "block";
    buktiContainer.style.display = "block";

    manualPayment.innerHTML = `
      <h3>Instruksi Pembayaran</h3>
      <p><b>${value}</b></p>
      <p>${paymentInfo[value]}</p>
      <hr>
      <p><b>Total: ${formatRupiah(total)}</b></p>
      <p>Silakan transfer lalu upload bukti di bawah.</p>
    `;
  });
checkoutForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!paymentSelect.value) {
    alert("Pilih metode pembayaran dulu!");
    return;
  }

  if (!buktiInput.files[0]) {
    alert("Upload bukti pembayaran dulu!");
    return;
  }

  try {
  const BUCKET_NAME = "bukti-transfer"; // âœ… TARUH DI ATAS

  const file = buktiInput.files[0];
  const fileName = `${Date.now()}-${file.name.replace(/\s/g, "-")}`;

  console.log("BUCKET:", BUCKET_NAME);

  // 1. UPLOAD BUKTI KE STORAGE
  const { error: uploadError } = await client.storage
    .from(BUCKET_NAME)
    .upload(fileName, file);

  if (uploadError) {
    console.error("UPLOAD ERROR:", uploadError);
    alert("Gagal upload bukti ke Supabase!");
    return;
  }

  // 2. AMBIL URL BUKTI
  const { data: publicData } = client.storage
    .from(BUCKET_NAME)
    .getPublicUrl(fileName);

  const buktiUrl = publicData.publicUrl;

  // 3. SIMPAN KE TABLE ORDERS
  const { data: orderData, error: orderError } = await client
    .from("orders")
    .insert([{
      nama: namaInput.value,
      telepon: teleponInput.value,
      alamat: alamatInput.value,
      metode: paymentSelect.value,
      total: Number(total),
      bukti_url: buktiUrl
    }])
    .select()
    .single();

  if (orderError) {
    console.error("ORDER ERROR:", orderError);
    alert("Gagal menyimpan data order!");
    return;
  }


    // 4. SIMPAN ITEM KE order_items
    const itemsData = cart.map(item => ({
      order_id: orderData.id,
      name: item.name || item.nama_produk || "Produk",
      size: item.size || item.ukuran || "-",
      price: Number(item.price || item.harga || 0),
      qty: Number(item.qty || item.jumlah || 1),
    }));

    const { error: itemsError } = await client
      .from("order_items")
      .insert(itemsData);

    if (itemsError) {
      console.error("ITEMS ERROR:", itemsError);
      alert("Gagal menyimpan data produk!");
      return;
    }

    // 5. SUKSES
    alert("Pesanan berhasil dikirim!");
    localStorage.removeItem("checkout");
    window.location.href = "success.html";

  } catch (err) {
    console.error("GLOBAL ERROR:", err);
    alert("Terjadi error tak terduga, cek console (F12)");
  }
});


});
</script>

</body>
</html>
